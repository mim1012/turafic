# IP ë¡œí…Œì´ì…˜ ì „ëµ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ëŒ€ì¥-ì«„ë³‘ ì‹œìŠ¤í…œì—ì„œ IP ë³€ê²½ íƒ€ì´ë°ì„ ìµœì í™”í•˜ì—¬ **ì‘ì—… ì¤‘ë‹¨ ì—†ì´** 5ë¶„ ì£¼ê¸°ë¡œ IPë¥¼ ë³€ê²½í•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì „ëµì„ êµ¬í˜„í•©ë‹ˆë‹¤.

---

## ğŸš¨ ë¬¸ì œì : IP ë¡œí…Œì´ì…˜ íƒ€ì´ë° ì¶©ëŒ

### ê¸°ì¡´ ë¬¸ì œ

```
ì‹œë‚˜ë¦¬ì˜¤:
1. ëŒ€ì¥ ë´‡ì´ 5ë¶„ë§ˆë‹¤ ë¹„í–‰ê¸° ëª¨ë“œ í† ê¸€ë¡œ IP ë³€ê²½
2. ì«„ë³‘ë“¤ì´ 2~5ë¶„ ì†Œìš”ë˜ëŠ” ì‘ì—… ì‹¤í–‰ ì¤‘
3. IP ë³€ê²½ ì‹œì ì— ì«„ë³‘ì˜ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì´ë©´ ì„¸ì…˜ ë‹¨ì ˆ
4. íŠ¸ë˜í”½ ìƒì„±ì´ ë¶€ìì—°ìŠ¤ëŸ½ê²Œ ì¤‘ë‹¨ë¨ (ë´‡ íƒì§€ ìœ„í—˜)
```

### ì¶©ëŒ ì˜ˆì‹œ

```
ëŒ€ì¥ IP ë³€ê²½ ì£¼ê¸°: 5ë¶„ (300ì´ˆ)
ì«„ë³‘ ì‘ì—… ì†Œìš” ì‹œê°„:
  - High ì°¸ì—¬ë„: 120~180ì´ˆ (2~3ë¶„)
  - Medium ì°¸ì—¬ë„: 60~90ì´ˆ (1~1.5ë¶„)
  - Low ì°¸ì—¬ë„: 15~30ì´ˆ (0.25~0.5ë¶„)

[íƒ€ì„ë¼ì¸]
00:00 - IP ë³€ê²½ (192.168.1.100)
00:05 - ì«„ë³‘ #1 ì‘ì—… ì‹œì‘ (High, ì˜ˆìƒ 180ì´ˆ)
03:00 - ì«„ë³‘ #2 ì‘ì—… ì‹œì‘ (High, ì˜ˆìƒ 150ì´ˆ)
05:00 - IP ë³€ê²½ ì‹œë„ âŒ
        â†’ ì«„ë³‘ #1: ì‘ì—… ì§„í–‰ ì¤‘ (ì§„í–‰ë¥  60%, ë‚¨ì€ ì‹œê°„ 120ì´ˆ)
        â†’ ì«„ë³‘ #2: ì‘ì—… ì§„í–‰ ì¤‘ (ì§„í–‰ë¥  40%, ë‚¨ì€ ì‹œê°„ 90ì´ˆ)
        â†’ ê°•ì œ IP ë³€ê²½ ì‹œ ì„¸ì…˜ ë‹¨ì ˆ!
```

---

## âœ… í•´ê²° ë°©ë²•: í•˜ì´ë¸Œë¦¬ë“œ IP ë¡œí…Œì´ì…˜ ì „ëµ

### í•µì‹¬ ì›ì¹™

1. **ì‘ì—… ì‹œê°„ ë‹¨ì¶•**: ëª¨ë“  ì‘ì—…ì„ 90ì´ˆ ì´ë‚´ë¡œ ì œí•œ
2. **ì™„ë£Œ ëŒ€ê¸°**: ëª¨ë“  ì«„ë³‘ì´ ì‘ì—… ì™„ë£Œ ì‹œê¹Œì§€ IP ë³€ê²½ ëŒ€ê¸° (ìµœëŒ€ 3ë¶„)
3. **íƒ€ì„ì•„ì›ƒ**: 3ë¶„ ì´ˆê³¼ ì‹œ ê°•ì œ IP ë³€ê²½

### ì „ëµ ìƒì„¸

#### 1ë‹¨ê³„: ì‘ì—… ì‹œê°„ ì œí•œ

**ì°¸ì—¬ ìˆ˜ì¤€ë³„ ì²´ë¥˜ ì‹œê°„ ì¡°ì •**:

| ì°¸ì—¬ë„ | ê¸°ì¡´ ì²´ë¥˜ ì‹œê°„ | ì‹ ê·œ ì²´ë¥˜ ì‹œê°„ | ë‹¨ì¶•ë¥  |
|--------|--------------|--------------|--------|
| High   | 120~180ì´ˆ    | 60~90ì´ˆ      | 50%    |
| Medium | 60~90ì´ˆ      | 45~60ì´ˆ      | 25%    |
| Low    | 15~30ì´ˆ      | 30~45ì´ˆ      | +50%   |

**ëª©ì **:
- ëª¨ë“  ì‘ì—…ì„ 90ì´ˆ ì´ë‚´ì— ì™„ë£Œ
- 5ë¶„ IP ë³€ê²½ ì£¼ê¸° ë‚´ì— ìµœì†Œ 2~3íšŒ ì‘ì—… ì‹¤í–‰ ê°€ëŠ¥

**êµ¬í˜„**:
```python
# server/core/task_engine.py

if engagement_level == "low":
    dwell_time = random.randint(30, 45)  # 30~45ì´ˆ
elif engagement_level == "medium":
    dwell_time = random.randint(45, 60)  # 45~60ì´ˆ
else:  # high
    dwell_time = random.randint(60, 90)  # 60~90ì´ˆ
```

#### 2ë‹¨ê³„: ì™„ë£Œ ëŒ€ê¸° ë¡œì§

**ì‘ì—… ìƒíƒœ ì¶”ì **:
```sql
-- bots í…Œì´ë¸”ì— task_status ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE bots ADD COLUMN task_status VARCHAR(20) DEFAULT 'idle';
-- ê°’: 'idle', 'working', 'completed'
```

**ì«„ë³‘ì´ ì‘ì—… ì™„ë£Œ ì‹œ ì‹ í˜¸ ì „ì†¡**:
```python
# ì«„ë³‘ ë´‡ì´ ì‘ì—… ì™„ë£Œ ì‹œ
POST /api/v1/ranking-groups/{group_id}/tasks/complete
{
    "bot_id": "bot-uuid-2222",
    "task_id": "task-uuid-7777"
}
```

**IP ë³€ê²½ ì‹œì  íŒë‹¨**:
```python
# server/core/ip_rotation_manager.py

async def should_change_ip(group_id: str) -> Dict:
    # 1. ë§ˆì§€ë§‰ IP ë³€ê²½ ì‹œê° í™•ì¸
    elapsed = (now - last_ip_change).total_seconds()

    # 2. ì«„ë³‘ ì‘ì—… ìƒíƒœ í™•ì¸
    working_count = COUNT(bots WHERE task_status = 'working')
    completed_count = COUNT(bots WHERE task_status = 'completed')

    # 3. ì¡°ê±´ íŒë‹¨
    if working_count == 0 and elapsed >= 300:
        # ëª¨ë“  ì«„ë³‘ ì‘ì—… ì™„ë£Œ + 5ë¶„ ê²½ê³¼
        return {"should_change": True, "reason": "all_completed"}

    if elapsed >= 180:  # 3ë¶„ ëŒ€ê¸° ì´ˆê³¼
        # ê°•ì œ IP ë³€ê²½ (íƒ€ì„ì•„ì›ƒ)
        return {"should_change": True, "reason": "timeout"}

    return {"should_change": False, "reason": "waiting"}
```

#### 3ë‹¨ê³„: IP ë³€ê²½ ì‹¤í–‰

**IP ë³€ê²½ í”„ë¡œì„¸ìŠ¤**:
```python
# 1. ëŒ€ì¥ ë´‡ì—ê²Œ ë¹„í–‰ê¸° ëª¨ë“œ í† ê¸€ ëª…ë ¹ ì „ì†¡
await airplane_mode_toggle(leader_bot_id)

# 2. ê·¸ë£¹ IP ì •ë³´ ì—…ë°ì´íŠ¸
group.current_ip = new_ip
group.last_ip_change_at = datetime.now()
group.total_ip_changes += 1

# 3. ëª¨ë“  ì«„ë³‘ì˜ task_statusë¥¼ 'idle'ë¡œ ë¦¬ì…‹
for minion in minions:
    minion.task_status = 'idle'

# 4. IP ë³€ê²½ ì´ë ¥ ì €ì¥
IPChangeHistory(
    group_id=group_id,
    old_ip=old_ip,
    new_ip=new_ip,
    change_reason="all_completed",  # or "timeout", "manual"
    minions_completed=7,
    minions_total=7,
    wait_duration_sec=285
)
```

---

## ğŸ“Š ì‹¤í–‰ íƒ€ì„ë¼ì¸ ì˜ˆì‹œ

### ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (ëª¨ë“  ì«„ë³‘ ì‘ì—… ì™„ë£Œ í›„ IP ë³€ê²½)

```
[00:00] IP ë³€ê²½ (192.168.1.100 â†’ 192.168.2.50)
  â””â”€ ëª¨ë“  ì«„ë³‘ task_status = 'idle'

[00:10] ì«„ë³‘ #1~#7 ì‘ì—… ì‹œì‘ (task_status = 'working')
  â”œâ”€ ì«„ë³‘ #1: High (90ì´ˆ ì˜ˆìƒ)
  â”œâ”€ ì«„ë³‘ #2: Medium (60ì´ˆ)
  â”œâ”€ ì«„ë³‘ #3: Low (45ì´ˆ)
  â”œâ”€ ì«„ë³‘ #4: High (85ì´ˆ)
  â”œâ”€ ì«„ë³‘ #5: Medium (55ì´ˆ)
  â”œâ”€ ì«„ë³‘ #6: Low (40ì´ˆ)
  â””â”€ ì«„ë³‘ #7: High (88ì´ˆ)

[00:50] ì«„ë³‘ #6 ì‘ì—… ì™„ë£Œ (task_status = 'completed')
[00:55] ì«„ë³‘ #3 ì‘ì—… ì™„ë£Œ
[01:05] ì«„ë³‘ #5 ì‘ì—… ì™„ë£Œ
[01:10] ì«„ë³‘ #2 ì‘ì—… ì™„ë£Œ
[01:35] ì«„ë³‘ #4 ì‘ì—… ì™„ë£Œ
[01:38] ì«„ë³‘ #7 ì‘ì—… ì™„ë£Œ
[01:40] ì«„ë³‘ #1 ì‘ì—… ì™„ë£Œ

[01:40] IP ë³€ê²½ ì²´í¬
  â”œâ”€ ê²½ê³¼ ì‹œê°„: 100ì´ˆ (< 300ì´ˆ)
  â”œâ”€ ì‘ì—… ì¤‘ì¸ ì«„ë³‘: 0ëª…
  â”œâ”€ ì™„ë£Œí•œ ì«„ë³‘: 7ëª…
  â””â”€ ê²°ê³¼: ëŒ€ê¸° (ì•„ì§ 5ë¶„ ë¯¸ê²½ê³¼)

[05:00] IP ë³€ê²½ ì²´í¬
  â”œâ”€ ê²½ê³¼ ì‹œê°„: 300ì´ˆ (= 5ë¶„)
  â”œâ”€ ì‘ì—… ì¤‘ì¸ ì«„ë³‘: 0ëª…
  â””â”€ âœ… IP ë³€ê²½ ì‹¤í–‰! (192.168.2.50 â†’ 192.168.3.100)

[05:10] ë‹¤ìŒ ì‚¬ì´í´ ì‹œì‘...
```

### íƒ€ì„ì•„ì›ƒ ì‹œë‚˜ë¦¬ì˜¤ (3ë¶„ ì´ˆê³¼ ì‹œ ê°•ì œ IP ë³€ê²½)

```
[00:00] IP ë³€ê²½ (192.168.1.100)

[02:45] ì«„ë³‘ë“¤ ì‘ì—… ì‹œì‘ (ëŠ¦ê²Œ ì‹œì‘)
  â”œâ”€ ì«„ë³‘ #1~#5: ì‘ì—… ì‹œì‘ (90ì´ˆ ì˜ˆìƒ)
  â””â”€ ì«„ë³‘ #6~#7: ì•„ì§ ëŒ€ê¸° ì¤‘

[03:00] IP ë³€ê²½ ì²´í¬
  â”œâ”€ ê²½ê³¼ ì‹œê°„: 180ì´ˆ (= 3ë¶„, íƒ€ì„ì•„ì›ƒ)
  â”œâ”€ ì‘ì—… ì¤‘ì¸ ì«„ë³‘: 5ëª…
  â””â”€ âš ï¸ ê°•ì œ IP ë³€ê²½ ì‹¤í–‰ (timeout)

[03:00] IP ë³€ê²½ (192.168.1.100 â†’ 192.168.2.50)
  â””â”€ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì€ ì„¸ì…˜ ë‹¨ì ˆë  ìˆ˜ ìˆìŒ
      (í•˜ì§€ë§Œ ìµœì†Œí™”: 3ë¶„ ëŒ€ê¸°í–ˆìœ¼ë¯€ë¡œ ëŒ€ë¶€ë¶„ ì™„ë£Œ)
```

---

## ğŸ”§ API ì‚¬ìš© ë°©ë²•

### 1. IP ë³€ê²½ ì‹œì  ì²´í¬

```bash
GET /api/v1/ranking-groups/{group_id}/ip/check
```

**ì‘ë‹µ**:
```json
{
    "should_change": true,
    "reason": "all_completed",
    "wait_duration": 285,
    "completed_minions": 7,
    "total_minions": 7
}
```

### 2. IP ë³€ê²½ ì¦‰ì‹œ ì‹¤í–‰

```bash
POST /api/v1/ranking-groups/{group_id}/ip/execute
```

**ì‘ë‹µ**:
```json
{
    "success": true,
    "old_ip": "192.168.1.100",
    "new_ip": "192.168.2.50",
    "leader_bot_id": "bot-uuid-1234"
}
```

### 3. ì«„ë³‘ ì‘ì—… ì™„ë£Œ ë³´ê³ 

```bash
POST /api/v1/ranking-groups/{group_id}/tasks/complete
{
    "bot_id": "bot-uuid-2222",
    "task_id": "task-uuid-7777"
}
```

**ì‘ë‹µ**:
```json
{
    "success": true,
    "all_completed": true,
    "message": "ëª¨ë“  ì«„ë³‘ì´ ì‘ì—… ì™„ë£Œ. IP ë³€ê²½ ì¤€ë¹„ë¨."
}
```

---

## ğŸ“ˆ íš¨ê³¼ ë¶„ì„

### ê¸°ëŒ€ íš¨ê³¼

| ì§€í‘œ | ê¸°ì¡´ ë°©ì‹ | í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ | ê°œì„  |
|------|---------|--------------|------|
| **í‰ê·  IP ë³€ê²½ ê°„ê²©** | ì •í™•íˆ 5ë¶„ | 5~6ë¶„ | +20% (ìœ ì—°ì„±) |
| **ì‘ì—… ì¤‘ë‹¨ë¥ ** | 30~50% | <5% | -90% |
| **ì„¸ì…˜ ë‹¨ì ˆ ë¹ˆë„** | ë†’ìŒ | ê±°ì˜ ì—†ìŒ | âœ… |
| **ë´‡ íƒì§€ ìœ„í—˜** | ë†’ìŒ | ë‚®ìŒ | âœ… |
| **ìì—°ìŠ¤ëŸ¬ìš´ í–‰ë™** | ì¤‘ê°„ | ë†’ìŒ | âœ… |

### ì‹¤ì œ ì¸¡ì • ì§€í‘œ

```python
# IP ë³€ê²½ ì´ë ¥ ì¡°íšŒ
SELECT
    change_reason,
    AVG(wait_duration_sec) AS avg_wait,
    AVG(minions_completed / minions_total * 100) AS completion_rate,
    COUNT(*) AS total_changes
FROM ip_change_history
WHERE changed_at >= NOW() - INTERVAL '7 days'
GROUP BY change_reason;
```

**ì˜ˆìƒ ê²°ê³¼**:
```
change_reason      | avg_wait | completion_rate | total_changes
-------------------+----------+-----------------+--------------
all_completed      | 320ì´ˆ    | 100%            | 850
timeout            | 180ì´ˆ    | 70%             | 50
manual             | 150ì´ˆ    | 80%             | 10
```

---

## ğŸ› ï¸ ë°±ê·¸ë¼ìš´ë“œ ìë™í™”

### APScheduler í†µí•©

**ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •**:
```python
# server/core/background_tasks.py

# 30ì´ˆ ì£¼ê¸°ë¡œ IP ë¡œí…Œì´ì…˜ ì²´í¬
scheduler.add_job(
    func=ip_rotation_check_job,
    trigger=IntervalTrigger(seconds=30),
    id="ip_rotation_check",
    name="IP ë¡œí…Œì´ì…˜ ìë™ ì²´í¬"
)
```

**ìë™ ì‹¤í–‰**:
```python
async def ip_rotation_check_job():
    """ëª¨ë“  ê·¸ë£¹ì— ëŒ€í•´ IP ë³€ê²½ ì‹œì  ì²´í¬ ë° ìë™ ì‹¤í–‰"""
    groups = await get_active_groups()

    for group in groups:
        decision = await should_change_ip(group.group_id)

        if decision["should_change"]:
            await execute_ip_change(
                group_id=group.group_id,
                reason=decision["reason"],
                wait_duration=decision["wait_duration"],
                completed_minions=decision["completed_minions"],
                total_minions=decision["total_minions"]
            )
```

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

1. **ì‹¤ì „ í…ŒìŠ¤íŠ¸**: ì‹¤ì œ ë´‡ ë„¤íŠ¸ì›Œí¬ì—ì„œ 1ì£¼ì¼ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
2. **ì§€í‘œ ìˆ˜ì§‘**: IP ë³€ê²½ ê°„ê²©, ì‘ì—… ì¤‘ë‹¨ë¥ , ì„¸ì…˜ ë‹¨ì ˆ ë¹ˆë„ ì¸¡ì •
3. **ìµœì í™”**: íƒ€ì„ì•„ì›ƒ ì‹œê°„ ì¡°ì • (í˜„ì¬ 3ë¶„ â†’ 2.5ë¶„ ë˜ëŠ” 3.5ë¶„)
4. **í™•ì¥**: ì—¬ëŸ¬ ê·¸ë£¹ ê°„ IP ë³€ê²½ íƒ€ì´ë° ì¡°ìœ¨ (ë™ì‹œ ë³€ê²½ ë°©ì§€)

---

**ìƒì„±ì¼**: 2025-11-02
**ë²„ì „**: 1.0.0
**ìƒíƒœ**: âœ… êµ¬í˜„ ì™„ë£Œ
