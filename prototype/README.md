# 프로토타입 테스트 가이드

## 목표

**1개 상품 × CASE_S3 시나리오 × 10회 반복 → 순위 변동 검증**

CASE_S3 (비교 쇼핑 후 최종 선택)이 실제로 네이버 쇼핑 순위에 영향을 미치는지 검증합니다.

---

## 사전 준비

### 1. 테스트 상품 선정

네이버 쇼핑에서 테스트할 상품을 선택하세요.

```bash
# 요구사항:
- 현재 검색 시 5페이지 이내에 노출되는 상품
- 검색 키워드가 명확한 상품
- 본인이 관리/테스트 권한이 있는 상품 (또는 테스트 목적 승인)
```

### 2. 상품 정보 수집

- **상품 ID**: URL의 숫자 부분 (예: `https://shopping.naver.com/window-products/12345678`)
- **검색 키워드**: 해당 상품이 검색되는 주요 키워드
- **경쟁사 URL**: 같은 키워드로 검색되는 경쟁 상품 2개

### 3. 초기 순위 확인

```bash
# 테스트 전 현재 순위 확인
python -c "
from src.ranking.checker import check_rank
rank = check_rank('검색키워드', '상품ID', max_page=5)
if rank:
    print(f'현재 순위: {rank[\"absolute_rank\"]}위')
else:
    print('순위권 밖 (5페이지 이내 없음)')
"
```

### 4. 화면 좌표 확인

좌표 기반 제어를 위해 기기의 정확한 좌표가 필요합니다.

#### 방법 1: 개발자 옵션 활용 (권장)

```bash
# 1. 안드로이드 개발자 옵션 활성화
설정 → 휴대전화 정보 → 빌드번호 7번 탭

# 2. 포인터 위치 표시 켜기
개발자 옵션 → 포인터 위치 ON

# 3. 화면을 터치하면 상단에 좌표가 표시됨
# 각 버튼/영역을 터치하여 좌표 기록:
#   - 검색창
#   - 쇼핑 탭
#   - 장바구니 버튼
#   - 뒤로가기 버튼
```

#### 방법 2: 화면 해상도로 추정

```bash
# 화면 해상도 확인
adb shell wm size

# 일반적인 좌표 (1080x2400 기준):
# - 화면 중앙: (540, 1200)
# - 상단 검색창: (540, 200)
# - 장바구니 버튼 (하단): (540, 2100)
# - 뒤로가기 (좌상단): (60, 150)
```

### 5. prototype_config.json 수정

수집한 정보로 설정 파일을 업데이트하세요.

```json
{
  "test_product": {
    "id": "실제상품ID",
    "product_name": "테스트 상품명",
    "product_url": "https://shopping.naver.com/window-products/실제상품ID",
    "search_keyword": "실제검색키워드",
    "competitor_urls": [
      "https://shopping.naver.com/window-products/경쟁사1ID",
      "https://shopping.naver.com/window-products/경쟁사2ID"
    ]
  },
  "screen": {
    "width": 1080,  // 실제 기기 해상도
    "height": 2400
  },
  "coordinates": {
    "cart_button": {
      "x": 540,  // 실제 좌표로 수정
      "y": 2100
    }
    // ... 다른 좌표들도 수정
  }
}
```

---

## 실행 방법

### 1. 환경 설정

```bash
# 가상환경 활성화
venv\Scripts\activate  # Windows
source venv/bin/activate  # Mac/Linux

# ADB 연결 확인
adb devices
# 출력: List of devices attached
#       DEVICE_ID       device
```

### 2. 단독 시나리오 테스트 (권장)

본격적인 10회 반복 전, 시나리오가 정상 작동하는지 1회만 테스트:

```bash
python prototype/prototype_browser.py
```

**확인 사항:**
- [ ] URL이 정상적으로 열리는가?
- [ ] 스크롤이 정상 작동하는가?
- [ ] 장바구니 버튼이 정확히 클릭되는가?
- [ ] 뒤로가기가 작동하는가?
- [ ] 에러 없이 완료되는가?

**문제 발생 시:**
- 좌표가 정확한지 재확인
- 네트워크 연결 상태 확인
- ADB 연결 안정성 확인

### 3. 프로토타입 전체 실행

단독 테스트가 성공하면 10회 반복 실행:

```bash
python prototype/prototype_main.py
```

**프롬프트 확인:**
```
테스트 준비 완료!
======================================================================
상품: [상품명]
시나리오: CASE_S3 (비교 쇼핑 후 최종 선택)
반복 횟수: 10회
예상 소요 시간: 약 90분 (iteration당 약 9분)
======================================================================

테스트를 시작하시겠습니까? (y/n):
```

`y` 입력 시 테스트 시작

---

## 실행 과정

각 iteration은 다음과 같이 진행됩니다:

```
Iteration N/10
├── 1. Before 순위 체크
│   └── 현재 순위 확인 (검색 크롤링)
├── 2. CASE_S3 시나리오 실행
│   ├── 경쟁 상품 A 보기 (30초)
│   ├── 경쟁 상품 B 보기 (30초)
│   └── 타겟 상품 상세 보기 (90-120초)
│       ├── 깊은 스크롤
│       ├── 관심 액션 (확률적)
│       └── 장바구니 담기 (확률적)
├── 3. IP 변경
│   └── 비행기모드 ON → OFF
├── 4. 5분 대기
│   └── (실제는 30분 권장)
├── 5. After 순위 체크
│   └── 변경된 순위 확인
└── 6. 결과 저장
    └── 순위 변동 기록
```

**1회 iteration 소요 시간: 약 9분**
- 시나리오 실행: 3-4분
- IP 변경: 30초
- 순위 반영 대기: 5분
- 순위 체크: 1분

**10회 전체 소요 시간: 약 90-100분**

---

## 결과 확인

### 실시간 로그

터미널에서 실시간으로 진행 상황을 확인할 수 있습니다:

```
[5] BEFORE 순위 체크 중...
✅ 순위 발견: 45위
   페이지: 3, 위치: 5

[5] 트래픽 생성 시작
=== CASE_S3 시나리오 시작: 비교 쇼핑 후 최종 선택 ===
=== 경쟁 상품 1 확인 ===
...
✅ [5] 트래픽 생성 완료

IP 변경 시작...
✅ IP 변경 성공: 192.168.0.10 → 192.168.0.15

[5] 순위 반영 대기 중... (5분)

[5] AFTER 순위 체크 중...
✅ 순위 발견: 42위

[5] 순위 변동 결과
Before: 45위
After:  42위
✅ 순위 상승: 3위 ↑
```

### 최종 통계

10회 완료 후 다음 통계가 출력됩니다:

```
=== 실행 통계 ===
총 시도: 10회
성공: 10회
실패: 0회

=== 순위 통계 ===
총 기록: 10회
평균 순위: 43.2위
최고 순위: 40위
최저 순위: 48위

평균 순위 변동: -2.8
✅ 평균 2.8위 상승

순위 개선율: 70.0%
```

### 데이터 파일

결과는 자동으로 저장됩니다:

```
data/
├── rankings/
│   └── rank_history_12345678.json  # 상세 히스토리
└── results/
    └── rank_history_12345678.csv   # 분석용 CSV
```

**CSV 파일 내용:**
```csv
iteration,rank,page,position,rank_change,timestamp
1,45,3,5,0,2025-01-01T10:00:00
2,43,3,3,-2,2025-01-01T10:15:00
3,42,3,2,-1,2025-01-01T10:30:00
...
```

---

## 검증 기준

### ✅ 성공 (다음 단계 진행)

- **10회 중 5회 이상** 순위 상승
- **평균 2-3위 이상** 상승
- 큰 에러 없이 안정적으로 동작

**→ 전체 시스템 구현 진행**

### ⚠️ 재검토 필요

- 순위 변동이 없거나 미미함 (평균 1위 미만)
- 에러가 빈번하게 발생

**→ 전략 수정 필요:**
- 체류 시간 증가
- 더 많은 액션 추가
- 다른 특수 케이스 시도 (CASE_S1, CASE_S2)

### ❌ 실패 (근본적 재설계)

- 순위가 오히려 하락
- 네이버 차단 (IP 밴, CAPTCHA)
- 반복 실행 불가

**→ 접근 방식 변경 필요**

---

## 문제 해결

### IP 변경이 안 될 때

```bash
# 수동으로 확인
adb shell settings get global airplane_mode_on
# 0: OFF, 1: ON

# 수동 토글
adb shell settings put global airplane_mode_on 1
adb shell am broadcast -a android.intent.action.AIRPLANE_MODE
```

### 좌표가 맞지 않을 때

```bash
# 스크린샷으로 확인
adb shell screencap -p /sdcard/screen.png
adb pull /sdcard/screen.png

# 이미지에서 버튼 위치 확인 후 좌표 수정
```

### 네트워크 타임아웃

```python
# prototype_config.json 수정
"timing": {
    "page_load_wait": 5.0,  # 3.0 → 5.0으로 증가
    "network_wait_timeout": 60  # 30 → 60으로 증가
}
```

### 순위 체크 실패

```bash
# 수동으로 순위 체크 테스트
python test_rank_checker.py

# HTML 선택자 업데이트 필요 시:
# src/ranking/checker.py 파일 수정
```

---

## 주의사항

### 1. 네이버 이용약관

- 테스트는 학습/연구 목적으로만 사용
- 과도한 요청은 서비스 차단 가능
- 자신이 관리하는 상품만 테스트 권장

### 2. 기기 관리

- **배터리**: 충전 상태 유지 (90분 소요)
- **발열**: 과열 시 휴식 시간 추가
- **화면**: 화면이 꺼지지 않도록 설정

### 3. 순위 체크 간격

- 프로토타입: 5분 대기
- 실제 테스트: **30분 대기 권장** (더 정확한 순위 반영)

### 4. 테스트 시간대

- 트래픽이 적은 시간대 권장 (새벽 2-6시)
- 순위 변동이 적어 효과 측정이 용이

---

## 다음 단계

### 프로토타입 성공 시

1. **특수 케이스 확장**
   - CASE_S1 (구매 완료 시뮬레이션)
   - CASE_S2 (재방문 패턴)
   - CASE_S7 (소셜 활동)

2. **상품 확대**
   - 1개 → 3개 → 10개 상품

3. **반복 횟수 증가**
   - 10회 → 30회 → 100회

4. **자동화 개선**
   - Pure ADB → Appium (더 안정적)
   - 좌표 기반 → 요소 인식

### 프로토타입 재검토 필요 시

1. **체류 시간 조정**
   - 경쟁사: 30초 → 45초
   - 타겟: 90-120초 → 120-180초

2. **액션 추가**
   - 리뷰 상세 읽기
   - Q&A 확인
   - 옵션 선택

3. **대기 시간 증가**
   - 5분 → 30분 (순위 반영)

---

## 지원

문제 발생 시:
1. `logs/` 디렉토리의 로그 파일 확인
2. GitHub Issues에 문의
3. 설정 파일 및 로그 첨부

---

**작성일**: 2025-11-01
**버전**: 프로토타입 v1.0
**시나리오**: CASE_S3 (비교 쇼핑 후 최종 선택)
